<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Dashboard</title>
    <link rel="stylesheet" href="/output.css">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Set canvas container size to 40% of screen */
        #chartContainer {
            width: 40vw;  /* 40% of viewport width */
            height: 40vh; /* 40% of viewport height */
        }
        canvas {
            width: 100% !important;
            height: 100% !important;
        }
    </style>
</head>
<body class="bg-[#faf5ef] p-5">

    <div class="fixed top-0 left-0 h-full w-[75px] bg-[#faf5ef] shadow-lg flex flex-col items-center justify-center">
        <button onclick="location.href='/dashboard'" class="p-4">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-[#5b3e2d]">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
          </svg>
        </button>
      </div>

    <div class="max-w-4xl mx-auto bg-white p-5 rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold text-gray-700 text-center">Sales Dashboard</h2>

        <div id="chartContainer" class="mx-auto">
            <canvas id="salesChart"></canvas>
        </div>

        <div class="mt-5 text-center">
            <span class="font-semibold text-gray-600">Filter By:</span>
            <div class="flex justify-center gap-3 mt-2">
                <button class="w-32 px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600"
                    onclick="MonthlySales()">Month</button>
                <button class="w-32 px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600"
                    onclick="SalesmanSale()">Salesman</button>
                <button class="w-32 px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600"
                    onclick="CategorySales()">Category</button>
            </div>
        </div>
        
    </div>

    <script>
        var salesChart = null; // Define chart globally to allow destruction
    
        function formatDateToMonYY(dateStr) {
            let date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
        }
    
        function fetchAndRenderChart(url, labelField, dataField, chartLabel) {
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error! Status: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Sales Data:", data); // Debugging output
    
                    var labels = data.map(entry => 
                        url === '/monthly/sale' ? formatDateToMonYY(entry[labelField]) : entry[labelField]);
                    var values = data.map(entry => entry[dataField]);
    
                    var ctx = document.getElementById('salesChart').getContext('2d');
    
                    // Destroy previous chart to prevent overlap
                    if (salesChart !== null) {
                        salesChart.destroy();
                    }
    
                    const isMonthly = url === '/monthly/sale';
                    const chartType = isMonthly ? 'bar' : 'pie';
    
                    const backgroundColors = [
                        'rgba(255, 99, 132, 0.5)',
                        'rgba(54, 162, 235, 0.5)',
                        'rgba(255, 206, 86, 0.5)',
                        'rgba(75, 192, 192, 0.5)',
                        'rgba(153, 102, 255, 0.5)',
                        'rgba(255, 159, 64, 0.5)'
                    ];
    
                    salesChart = new Chart(ctx, {
                        type: chartType,
                        data: {
                            labels: labels,
                            datasets: [{
                                label: chartLabel,
                                data: values,
                                backgroundColor: backgroundColors,
                                borderColor: backgroundColors.map(color => color.replace('0.5', '1')),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            
                            responsive: true,
                            maintainAspectRatio: false, // Allows custom sizing
                            scales: isMonthly ? {
                                y: {
                                    beginAtZero: true
                                }
                            } : {}
                        }
                    });
                })
                .catch(error => {
                    console.error('Error fetching sales data:', error);
                });
        }
    
        function SalesmanSale() {
            fetchAndRenderChart('/salesman/sale', 'username', 'total_sum', 'Sales by Salesman');
        }
    
        function MonthlySales() {
            fetchAndRenderChart('/monthly/sale', 'month', 'total_sum', 'Monthly Sales');
        }

        function CategorySales() {
            fetchAndRenderChart('/category/sale', 'category', 'total_sum', 'Category Sales');
        }
    
        MonthlySales(); // Load monthly sales chart on page load
    </script>
    
</body>
</html>
